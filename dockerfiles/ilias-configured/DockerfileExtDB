FROM whiledo/ilias-base:latest
MAINTAINER Kevin Krummenauer <kevin@whiledo.de>

ENV httppath="http://localhost" \
    iliaspath="ilias" \
    timezone="Europe/Berlin" \
    clientid="myilias" \
    iliasmasterpassword="secret" \
    mysqlhost="127.0.0.1" \
    mysqluser="root" \
    mysqlpassword="my-secret-pw" \
    mysqldbname="ilias" \
    mysqlport="3306" \
    language="de" \
    initmysql="no" \
    initadminfirstname="John" \
    initadminlastname="Doe" \
    initadminemail="John.Doe@example.com" \
    initfeedbackemail="John.Doe@example.com"

WORKDIR /data
ADD ./resources /data/resources/configured

RUN mkdir -p /var/www/html/ilias/data/myilias/css
RUN mkdir -p /var/www/html/ilias/data/myilias/lm_data
RUN mkdir -p /var/www/html/ilias/data/myilias/mobs
RUN mkdir -p /var/www/html/ilias/data/myilias/usr_images
RUN cp /data/resources/configured/ilias.ini.php /var/www/html/ilias
RUN cp /data/resources/configured/client.ini.php /var/www/html/ilias/data/myilias
RUN chown -R www-data:www-data /var/www/html/ilias
RUN chmod -R 775 /var/www/html/ilias/data
RUN chmod 666 /var/www/html/ilias/ilias.ini.php
RUN chmod 666 /var/www/html/ilias/data/myilias/client.ini.php

RUN mkdir -p /opt/iliasdata/myilias/files
RUN mkdir -p /opt/iliasdata/myilias/forum
RUN mkdir -p /opt/iliasdata/myilias/lm_data
RUN mkdir -p /opt/iliasdata/myilias/mail
RUN chown -R www-data:www-data /opt/iliasdata
RUN chmod -R 751 /opt/iliasdata

RUN chown www-data:www-data /data/resources/configured/entrypoint.sh
RUN chmod 751 /data/resources/configured/entrypoint.sh

COPY ./wait.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/wait.sh
ENTRYPOINT ["/usr/local/bin/wait.sh"]

#run apache in foreground mode, otherwise docker would stop running image directly after having started
CMD bash /data/resources/configured/entrypoint.sh
